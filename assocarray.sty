% !TeX encoding = UTF-8
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                    %
\def\assocarrayname           {assocarray}                           %
\def\xstringversion              {0.01}                              %
%                                                                    %
\def\xstringdate              {2020/12/14}                           %
%                                                                    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                    %
% Author     : João Lourenço                                         %
% Status     : Maintained                                            %
% Maintainer : João Lourenço                                         %
% Email      : joao.lourenco@fct.unl.pt                              %
% Package URL:                                                       %
% Bug tracker: https://github.com/joaomlourenco/assocarray/issues    %
% Repository : https://github.com/joaomlourenco/assocarray           %
% Copyright  : João Lourenço 2020                                    %
% Licence    : Released under the LaTeX Project Public License v1.3c %
%              or later, see http://www.latex-project.org/lppl.txt   %
% Files      : 1) assocarray.sty                                     %
%              2) assocarray.tex                                     %
%              3) assocarray-example.tex                             %
%              4) README                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[1995/12/01]

\ProvidesPackage{assocarray}[\xstringdate\space v\xstringversion\space, Joao Lourenco, Provides an associative array]

\RequirePackage{xstring}

\newif\ifopt@debug
\DeclareOption{debug}{\opt@debugtrue}
\ProcessOptions\relax

\providecommand*\csnewcommand{\@star@or@long\csnew@command}
\providecommand*\csnew@command[1]{\expandafter\new@command\csname#1\endcsname}
\providecommand*\recsnewcommand{\@star@or@long\recsnew@command}
\providecommand*\recsnew@command[1]{\expandafter\renew@command\csname#1\endcsname}

% Shamelessly tolen from etoolbox
\providecommand*{\csedef}[1]{\expandafter\edef\csname#1\endcsname}
\providecommand*{\csuse}[1]{%
  \ifcsname#1\endcsname%
    \csname#1\expandafter\endcsname%
  \fi%
}
\providecommand*{\ifcsdef}[1]{%
  \ifcsname#1\endcsname%
    \expandafter\@firstoftwo%
  \else%
    \expandafter\@secondoftwo%
  \fi%
}


\newcommand*{\assocarray}[1]{%
  \csnewcommand*{#1}[1][]{\@ifstar{\@assocarraydefstar@ii{#1}{##1}}{\@assocarraydefuse@ii{#1}{##1}}}%
  %% The following command is only for backward compatibility
  \csnewcommand{the#1}[1][]{\@assocarrayuse@ii{#1}{##1}}%
}

\newcommand*{\@assocarraydefstar@ii}[2]{%
  % \typeout{ASSOCARRAYSTAR @assocarraydefstar@ii -#1- -#2-}%
  \@ifnextchar:{\@assocarraydefstar@iiia{#1}}{\@assocarraydefstar@iiib{#1}}%
}

\def\@assocarraydefstar@iiia#1:=#2{%
  \@assocarraydefstar@iiib#1[]:={#2[]}%
}

\def\@assocarraydefstar@iiib#1[#2]:=#3{%
  \@assocarraydefstar@split#3{\@assocarraydefstar@Vkey}{\@assocarraydefstar@Vidx}%
  \csedef{@assocarray@#1*@idx}{#2}%
  \csedef{@assocarray@#1*@Vkey}{\@assocarraydefstar@Vkey}%
  \csedef{@assocarray@#1*@Vidx}{\@assocarraydefstar@Vidx}%
  \typeout{ASSOCARRAYSTAR @assocarraydefstar@iiib @assocarray@#1*@idx=#2}%
  \typeout{ASSOCARRAYSTAR @assocarraydefstar@iiib @assocarray@#1*@Vkey=\@assocarraydefstar@Vkey}%
  \typeout{ASSOCARRAYSTAR @assocarraydefstar@iiib @assocarray@#1*@Vidx=\@assocarraydefstar@Vidx}%
}

\def\@assocarraydefstar@split#1[#2]#3#4{%
  \def#3{#1}%
  \def#4{#2}%
}

\newcommand*{\@assocarraydefuse@ii}[2]{%
  % #1 = name
  % #2 = index
  % \typeout{ASSOCARRAY @assocarraydefuse@ii #1 #2}%
  \@ifnextchar:{\@assocarraydef@iii{#1}{#2}}{\@assocarrayuse@ii{#1}{#2}}%
}

\def\@assocarraydef@iii#1#2:=#3{%
  % #1 = name
  % #2 = index
  % #3 = value
  % \typeout{ASSOCARRAY@assocarraydef@iii  @assocarray@#1@#2=#3}%
  \csedef{@assocarray@#1@#2}{#3}%
}

\newcommand{\@assocarrayuse@ii}[2]{%
  % #1 = name
  % #2 = index
  % \typeout{ASSOCARRAY use #1 #2}%
  \ifcsdef{@assocarray@#1@#2}{%
    % Direct use
    \csuse{@assocarray@#1@#2}%
  }{% Maybe it is a redirection
    \ifcsdef{@assocarray@#1*@Vkey}{%
      % Definitely is a redirection
      \IfEq{\csuse{@assocarray@#1*@idx}}{}{%
        % Full redirction
        \@assocarrayuse@ii{\csuse{@assocarray@#1*@Vkey}}{#2}%
      }{% Maybe partial redirection
              % @assocarray@#1*@idx=\csuse{@assocarray@#1*@idx}\par
              % @assocarray@#1*@Vkey=\csuse{@assocarray@#1*@Vkey}\par
              % @assocarray@#1*@Vidx=\csuse{@assocarray@#1*@Vidx}\par
              \StrCut{\csuse{@assocarray@#1*@idx}}{*}\@assocarray@idx@left\@assocarray@idx@right%
              \StrCut{\csuse{@assocarray@#1*@Vidx}}{*}\@assocarray@Vidx@left\@assocarray@Vidx@right%
              % \#1=#1\par
              % \#2=#2\par
              % @assocarray@idx@left='\@assocarray@idx@left'\par
              % @assocarray@idx@right='\@assocarray@idx@right'\par
              % @assocarray@Vidx@left='\@assocarray@Vidx@left'\par
              % @assocarray@Vidx@right='\@assocarray@Vidx@right'\par
              \StrDel{#2}{\@assocarray@idx@left}[\@assocarray@star@right]%
              \StrDel{\@assocarray@star@right}{\@assocarray@idx@right}[\@assocarray@star]%
              % @assocarray@star=\@assocarray@star\par
              \ifcsdef{@assocarray@%
                       \csuse{@assocarray@#1*@Vkey}@%
                       \csuse{@assocarray@Vidx@left}%
                       \@assocarray@star%
                       \csuse{@assocarray@Vidx@right}}{%
                  \@assocarrayuse@ii{%
                       \csuse{@assocarray@#1*@Vkey}%
                  }{%
                       \csuse{@assocarray@Vidx@left}%
                       \@assocarray@star%
                       \csuse{@assocarray@Vidx@right}%
                  }%
              }{% Invalid partial redirection
                  \errmessage{[2] assocarray undefined: #1[#2]}%
              }%
      }%
    }{% No redirection
      \errmessage{[3] assocarray undefined: #1[#2]}%
    }%
  }%
}      
      
\endinput


        {%
          \IfEq{#2}{}%
            {% Full redirection — indirect use without index
              \IfEq{\csuse{@assocarray@#1*@idx}}{}%
                {[u2] {\csuse{\csuse{@assocarray@#1*@Vkey}}}}%
                {\errmessage{[1] assocarray undefined: #1 [#2]}}%
            }%
            {% Indirect use with index
              % @assocarray@#1*@idx=\csuse{@assocarray@#1*@idx}\par
              % @assocarray@#1*@Vkey=\csuse{@assocarray@#1*@Vkey}\par
              % @assocarray@#1*@Vidx=\csuse{@assocarray@#1*@Vidx}\par
              \StrCut{\csuse{@assocarray@#1*@idx}}{*}\@assocarray@idx@left\@assocarray@idx@right%
              \StrCut{\csuse{@assocarray@#1*@Vidx}}{*}\@assocarray@Vidx@left\@assocarray@Vidx@right%
              % \#1=#1\par
              % \#2=#2\par
              % @assocarray@idx@left='\@assocarray@idx@left'\par
              % @assocarray@idx@right='\@assocarray@idx@right'\par
              % @assocarray@Vidx@left='\@assocarray@Vidx@left'\par
              % @assocarray@Vidx@right='\@assocarray@Vidx@right'\par
              \StrDel{#2}{\@assocarray@idx@left}[\@assocarray@star@right]%
              \StrDel{\@assocarray@star@right}{\@assocarray@idx@right}[\@assocarray@star]%
              % @assocarray@star=\@assocarray@star\par
              \ifcsdef{@assocarray@%
                       \csuse{@assocarray@#1*@Vkey}@%
                       \csuse{@assocarray@Vidx@left}%
                       \@assocarray@star%
                       \csuse{@assocarray@Vidx@right}}%
              {%
                [u3] \csuse{@assocarray@%
                            \csuse{@assocarray@#1*@Vkey}@%
                            \csuse{@assocarray@Vidx@left}%
                            \@assocarray@star%
                            \csuse{@assocarray@Vidx@right}}%
              }%
              {\errmessage{[2] assocarray undefined: #1[#2]}}%
            }%
        }%
        {\errmessage{[3] assocarray undefined: #1[#2]}}%
    }%
}

\endinput